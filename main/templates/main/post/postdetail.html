{% extends 'main/base.html' %}
{% load static %}

{# ========================================================== #}
{# 1. SEO를 위한 헤더 정보 블록                                  #}
{# ========================================================== #}
{% block title %}{{ post.post_title }} - {{ blog_info.blog_title }}{% endblock %}

{% block extra_head %}
    {# 페이지 전용 CSS 로드 #}
    <link rel="stylesheet" href="{% static 'css/post/postdetail.css' %}">

    {# SEO를 위한 메타 태그 #}
    <meta name="description" content="{{ post.post_contents|striptags|truncatechars:150 }}">
    <meta name="author" content="{{ post.post_blog.blog_user.username }}">
    <link rel="canonical" href="{{ request.build_absolute_uri }}">

    {# 소셜 미디어 공유를 위한 Open Graph 태그 #}
    <meta property="og:title" content="{{ post.post_title }}">
    <meta property="og:description" content="{{ post.post_contents|striptags|truncatechars:150 }}">
    <meta property="og:url" content="{{ request.build_absolute_uri }}">
    <meta property="og:type" content="article">
    {# <meta property="og:image" content="포스트 대표 이미지 URL"> #}

    {# 검색 엔진에 콘텐츠의 의미를 명확히 전달하는 구조화된 데이터 (JSON-LD) #}
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "BlogPosting",
      "headline": "{{ post.post_title }}",
      "description": "{{ post.post_contents|striptags|truncatechars:150 }}",
      "datePublished": "{{ post.post_date|date:'c' }}",
      "author": {
        "@type": "Person",
        "name": "{{ post.post_blog.blog_user.username }}"
      }
    }
    </script>
{% endblock %}


{# ========================================================== #}
{# 2. 시맨틱 태그와 모던한 레이아웃을 적용한 본문 블록             #}
{# ========================================================== #}
{% block content %}
<div class="post-container">

    {# 시맨틱한 article 태그로 포스트 전체를 감쌉니다 #}
    <article class="post-article">
        
        {# 포스트 헤더: 제목, 메타 정보 #}
        <header class="post-header">
            <p class="post-category">{{ post.post_category_for.category_name }}</p>
            <h1 class="post-title">{{ post.post_title }}</h1>
            <div class="post-meta">
                <span class="meta-author">{{ post.post_blog.blog_user.username }}</span>
                <span class="meta-divider">·</span>
                <time class="meta-date" datetime="{{ post.post_date|date:'c' }}">{{ post.post_date|date:"Y년 m월 d일" }}</time>
            </div>
        </header>

        {# 포스트 본문 #}
        <div class="post-content">
            {{ post.post_contents|safe }}
        </div>
        
        {# 포스트 푸터: 태그, 공유 버튼 등 #}
        <footer class="post-footer">
            <div class="action-buttons">
                <a href="{% url 'showblog' blog_id=post.post_blog.blog_id %}" class="btn btn-list">&larr; 목록으로</a>
                {# 글 작성자에게만 수정/삭제 버튼이 보이도록 처리 #}
                {% if user == post.post_blog.blog_user %}
                <a href="{% url 'edit_post' post.post_id %}" class="btn btn-edit">✏️ 수정</a>
                <form method="post" action="{% url 'delete_post' post.post_id %}" onsubmit="return confirm('정말로 삭제하시겠습니까?');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-delete">❌ 삭제</button>
                </form>
                {% endif %}
            </div>
        </footer>

    </article>

    {# 댓글 섹션 #}
    <section class="comment-section">
        <h2 class="comment-title">댓글 ({{ comments.count }})</h2>
        
        {# 댓글 목록 #}
        <div class="comment-list">
            {% for comment in comments %}
            <div class="comment-item {% if comment.comment_isreply %}is-reply{% endif %}" id="comment-{{ comment.comment_id }}">
                <div class="comment-author">{{ comment.comment_editor_uid }}</div>
                <div class="comment-content">
                    <p>{{ comment.comment_contents }}</p>
                </div>
                <div class="comment-actions">
                    <time>{{ comment.comment_date|date:"y.m.d H:i" }}</time>
                    {% if not comment.comment_isdelete %}
                        <a href="#comment-form" class="reply-btn" data-comment-id="{{ comment.comment_id }}">답글</a>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <p class="no-comments">아직 댓글이 없습니다. 첫 댓글을 남겨보세요!</p>
            {% endfor %}
        </div>

        {# 댓글 작성 폼 #}
        <div class="comment-form-container" id="comment-form">
            <form action="{% url 'createcomment' post.post_id %}" method="post">
                {% csrf_token %}
                <textarea name="comment_contents" placeholder="따뜻한 댓글을 남겨주세요." required></textarea>
                <button type="submit">댓글 등록</button>
            </form>
        </div>
    </section>

</div>
{% endblock %}