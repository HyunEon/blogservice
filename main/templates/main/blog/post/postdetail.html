{% extends 'main/base.html' %}
{% load static %}

{% block title %}{{ post.post_title }}{% endblock %}

{% block extra_head %}
    <!-- CSS -->
    <link rel="stylesheet" href="{% static 'css/blog/post/postdetail.css' %}">
    <link rel="stylesheet" href="https://cdn.ckeditor.com/ckeditor5/47.1.0/ckeditor5.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <!-- JS -->
    <script src="{% static 'js/post/postdetail.js' %}"></script>

    <!-- SEOë¥¼ ìœ„í•œ ë©”íƒ€ íƒœê·¸ -->
    <meta name="description" content="{{ post.post_contents|striptags|truncatechars:150 }}">
    <meta name="author" content="{{ post.post_blog.blog_user.username }}">
    <link rel="canonical" href="{{ request.build_absolute_uri }}">

    <!-- ì†Œì…œ ë¯¸ë””ì–´ ê³µìœ ë¥¼ ìœ„í•œ Open Graph íƒœê·¸ -->
    <meta property="og:title" content="{{ post.post_title }}">
    <meta property="og:description" content="{{ post.post_contents|striptags|truncatechars:150 }}">
    <meta property="og:url" content="{{ request.build_absolute_uri }}">
    <meta property="og:type" content="article">
    <!-- <meta property="og:image" content="í¬ìŠ¤íŠ¸ ëŒ€í‘œ ì´ë¯¸ì§€ URL"> -->

    <!-- ê²€ìƒ‰ ì—”ì§„ì— ì½˜í…ì¸ ì˜ ì˜ë¯¸ë¥¼ ëª…í™•íˆ ì „ë‹¬í•˜ëŠ” êµ¬ì¡°í™”ëœ ë°ì´í„° (JSON-LD) -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "BlogPosting",
      "headline": "{{ post.post_title }}",
      "description": "{{ post.post_contents|striptags|truncatechars:150 }}",
      "datePublished": "{{ post.post_date|date:'c' }}",
      "author": {
        "@type": "Person",
        "name": "{{ post.post_blog.blog_user.username }}"
      }
    }
    </script>
    
{% endblock %}

{% block content %}
<div class="post-container">
    <!-- ì‹œë§¨í‹±í•œ article íƒœê·¸ë¡œ í¬ìŠ¤íŠ¸ ì „ì²´ë¥¼ ê°ìŒ‰ë‹ˆë‹¤ -->
    <article class="post-article">
        <!-- í¬ìŠ¤íŠ¸ í—¤ë”: ì œëª©, ë©”íƒ€ ì •ë³´ -->
        <header class="post-header" style="text-align: {{ post.title_align }}">
            <a href="{% url 'showblogbycategory' blog_slug=post.post_blog.slug category_slug=category.slug %}" class="post-category">{{ category.category_name }}</a>
            <h1 class="post-title">{{ post.post_title }}</h1>
            <div class="post-meta">
                <img src="{{ post.post_blog.blog_user.profile_image.url }}" alt="í”„ë¡œí•„" class="profile-img">
                <span class="meta-author">{{ post.post_blog.blog_user.nickname }}</span>
                <span class="meta-divider">Â·</span>
                <time class="meta-date" datetime="{{ post.post_date|date:'c' }}">{{ post.post_date|date:"Yë…„ mì›” dì¼ H:i" }}</time>
            </div>
        </header>

        <!-- í¬ìŠ¤íŠ¸ ë³¸ë¬¸ -->
         <div class="ck-content">
            {{ post.post_contents|safe }}
        </div>
        
        <!-- í¬ìŠ¤íŠ¸ í‘¸í„°: íƒœê·¸, ê³µìœ  ë²„íŠ¼ ë“± -->
        <footer class="post-footer">
            <div class="action-buttons">
                <a href="{% url 'showblog' blog_slug=post.post_blog.slug %}" class="btn btn-list">&larr; ëª©ë¡ìœ¼ë¡œ</a>
                <!-- ê¸€ ì‘ì„±ìì—ê²Œë§Œ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ì´ ë³´ì´ë„ë¡ ì²˜ë¦¬ -->
                {% if user == post.post_blog.blog_user %}
                <div class="edit-delete-buttons">
                    <a href="{% url 'editpost' blog_slug=post.post_blog.slug post_slug=post.slug %}" class="btn btn-edit">âœï¸ ìˆ˜ì •</a>
                    <form method="post" action="{% url 'deletepost' blog_slug=blog.slug post_slug=post.slug %}" onsubmit="return confirm('ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-delete">âŒ ì‚­ì œ</button>
                    </form>
                </div>
                {% endif %}
            </div>
        </footer>
    </article>

    <!-- ì¢‹ì•„ìš” ì„¹ì…˜ -->
    <div class="post-reactions">
        {% if user.is_authenticated %}
        <button class="like-btn {% if liked %}liked{% endif %}" data-post-id="{{ post.post_id }}">
            <span class="material-symbols-outlined">favorite</span>
            <span class="like-count">{{ post.likes.count }}</span>
        </button>
        {% else %}
        <button class="like-btn" disabled onclick="alert('ë¡œê·¸ì¸ í›„ ì‚¬ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤!');">
            <span class="material-symbols-outlined">favorite</span>
            <span class="like-count">{{ post.likes.count }}</span>
        </button>
        {% endif %}
    </div>

    <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
    <section class="comment-section">
        <h2 class="comment-title">ëŒ“ê¸€ ({{ comments.count }})</h2>
        
        <!-- ëŒ“ê¸€ ëª©ë¡ -->
        <div class="comment-list">
            {% for comment in comments %}
            <div class="comment-item {% if comment.comment_isreply %}is-reply{% endif %}" id="comment-{{ comment.comment_id }}">
                <div class="comment-author">
                    {% if comment.comment_editor.blog_user %}
                    <div class = "author-info">
                        {% if not comment.comment_isdelete %}
                        <img src="{{ comment.comment_editor.blog_user.profile_image.url }}" alt="í”„ë¡œí•„ ì´ë¯¸ì§€" class="comment-profile-img">
                        <span>{{ comment.comment_editor.blog_user.nickname }}</span>
                        {% endif %}
                    </div>
                    {% else %}
                    
                        <span>íƒˆí‡´í•œ ì‚¬ìš©ì ğŸ’€</span>
                    {% endif %}
                    <!-- ë³¸ì¸ ëŒ“ê¸€ì—ë§Œ ë”ë³´ê¸° ë²„íŠ¼ -->
                    {% if not comment.comment_isdelete and user.is_authenticated and comment.comment_editor == user_blog %}
                    <div class="comment-more-menu">
                        <button type="button" class="more-btn" data-comment-id="{{ comment.comment_id }}">
                            <span class="material-icons">more_horiz</span>
                        </button>
                        <div class="more-menu hidden" id="more-menu-{{ comment.comment_id }}">
                            <a href="#" class="comment-edit-btn" data-comment-id="{{ comment.comment_id }}">ìˆ˜ì •</a>
                            <!-- ëŒ“ê¸€ ì‚­ì œ í…œí”Œë¦¿ -->
                            <form method="post" action="{% url 'deletecomment' blog_slug=post.post_blog.slug post_slug=post.slug %}" onsubmit="return confirm('ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                                {% csrf_token %}
                                <input type="hidden" name="comment_id" value="{{ comment.comment_id }}">
                                <button type="submit" class="comment-delete-btn">ì‚­ì œ</button>
                            </form>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="comment-content">
                    {% if not comment.comment_isdelete %}
                    {% if comment.mention %}
                            <span class="mention">@{{ comment.mention.nickname }}</span>
                        {% endif %}
                        <div class="comment-body">
                            {{ comment.comment_contents|linebreaks }}
                        </div>
                    {% else %}
                        <p>ì‚­ì œëœ ëŒ“ê¸€ì…ë‹ˆë‹¤.</p>
                    {% endif %}
                </div>
                <div class="comment-actions">
                    {% if not comment.comment_isdelete %}
                    <time>{{ comment.comment_date|date:"y.m.d H:i" }}</time>
                    {% endif %}
                    {% if not comment.comment_isdelete and user.is_authenticated %}
                        <a class="comment-reply-btn" data-comment-id="{{ comment.comment_id }}" data-mention-id="{{ comment.comment_editor.blog_user.id }}" data-nickname="{{ comment.comment_editor.blog_user.nickname }}">ë‹µê¸€</a>
                    {% endif %}
                </div>
            </div>
            <!-- ë‹µê¸€, ìˆ˜ì • í…œí”Œë¦¿ -->
            <div id="comment-edit-reply-form-template" style="display: none;">
                <form method="post" action="{% url 'createcomment' blog_slug=post.post_blog.slug post_slug=post.slug %}" id="comment-edit-reply-form" class="comment-edit-reply-form">
                    <span class="mention-to-user"></span>
                    {% csrf_token %}
                    <div class="comment-form-contents">
                        <img src="{{ user_blog.blog_user.profile_image.url }}" alt="í”„ë¡œí•„" class="profile-img">
                        <textarea name="comment_contents" class="edit-textarea" required></textarea>
                    </div>
                    <div class="comment-edit-reply-buttons">
                        <button type="submit" class="save-edit-btn">ëŒ“ê¸€ ë“±ë¡</button>
                        <button type="button" class="cancel-edit-btn">ì·¨ì†Œ</button>
                    </div>
                    <!-- comment_id hidden ì „ë‹¬ -->
                    <input type="hidden" name="parent_comment_id" id="parent-comment-id"  value="{{ comment.comment_id }}">
                    <input type="hidden" name="mention" id="mention_id">
                    <input type="hidden" name="comment_id" value="">
                </form>
            </div>
        {% empty %}
            <p class="no-comments">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</p>
        {% endfor %}
    </div>
        <!--ëŒ“ê¸€ ì‘ì„± í¼ -->
        <div class="comment-form-container">
            <form action="{% url 'createcomment' blog_slug=blog.slug post_slug=post.slug %}" method="post">
                {% csrf_token %}
                {% include "main/form_errors.html" %}
                <div class="comment-form-contents">
                    {% if user.is_authenticated %}
                    <img src={{ user_blog.blog_user.profile_image.url }} alt="í”„ë¡œí•„" class="profile-img">
                    {{ form.comment_contents }}
                    {% else %}
                    <span>ë¡œê·¸ì¸ í›„ ëŒ“ê¸€ì„ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!</span>
                    {% endif %}
                </div>
                <button type="submit"{% if not user.is_authenticated %}disabled title="ë¡œê·¸ì¸ í›„ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤"{% endif %}>ëŒ“ê¸€ ë“±ë¡</button>
            </form>
        </div>
    </section>
</div>
{% endblock %}